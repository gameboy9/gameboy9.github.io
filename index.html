<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>
	<div>
		<label for="playerCount">Number of players (2-1000):</label>
		<input type="number" id="playerCount" name="playerCount" min="2" max="1000" value="50" />
	</div>
		
	<div>
		<label for="groupSize">Group size:</label>
		<input list="groupSizeList" id="groupSize" name="groupSize" placeholder="4" value="4" />
		<datalist id="groupSizeList">
		   <option>2
		   <option>3
		   <option>4
		</datalist>
	</div>
	<div>
		<label for="strikes">Number of strikes (1-100):</label>
		<input type="number" id="strikes" name="strikes" min="1" max="100" value="4" />
	</div>

	<div>
		<label for="playersLeft">Number of players left (1-1000):</label>
		<input type="number" id="playersLeft" name="playersLeft" min="1" max="1000" value="1" />
	</div>
		
	<div>
		<label for="commonFormats">Common Formats:</label>
		<input list="commonFormatList" id="commonFormats" name="commonFormats" placeholder="Fair strikes" value="Fair strikes" />
		<datalist id="commonFormatList">
		   <option>Fair strikes
		   <option>Progressive strikes
		   <option>Single/Slow strikes
		   <option>Lenient group strikes
		   <option>Strict group strikes
		   <option>Oprah strikes
		</datalist>
	</div>
		
	<div>
		<label><b>Strike distribution:</b></label>
	</div>

	<div>
		<label>2P Groups:</label>
		<input type="number" id="p21" name="p21" min="2" max="100" value="0" />
		<input type="number" id="p22" name="p22" min="2" max="100" value="2" />
	</div>

	<div>
		<label>3P Groups:</label>
		<input type="number" id="p31" name="p31" min="2" max="100" value="0" />
		<input type="number" id="p32" name="p32" min="2" max="100" value="1" />
		<input type="number" id="p33" name="p33" min="2" max="100" value="2" />
	</div>

	<div>
		<label>4P Groups:</label>
		<input type="number" id="p41" name="p41" min="2" max="100" value="0" />
		<input type="number" id="p42" name="p42" min="2" max="100" value="1" />
		<input type="number" id="p43" name="p43" min="2" max="100" value="1" />
		<input type="number" id="p44" name="p44" min="2" max="100" value="2" />
	</div>

	<div>
		<button type="button" onclick="calcKnockoutTournament()">Calculate TGP</button>
	</div>
	
	<div>
		<label>Result:</label>
		<textarea id="tgpResult" name="tgpResult" rows="17" cols="80"></textarea>
	</div>
</body>
</html>

<script>
	class Player {
		constructor(id, topScore) {
			this.id = id;
			this.topScore = topScore;
			this.strikes = 0;
			this.score = 0;
		}
	}

	function calcKnockoutTournament() {	
		let players = parseInt(document.getElementById("playerCount").value);
		let finalStrikes = parseInt(document.getElementById("strikes").value);
		let finalPlayers = parseInt(document.getElementById("playersLeft").value);
		let strikeDist = [ 
			[
				parseInt(document.getElementById("p21").value),
				parseInt(document.getElementById("p22").value),
				parseInt(document.getElementById("p22").value),
				parseInt(document.getElementById("p22").value)
			], [
				parseInt(document.getElementById("p31").value),
				parseInt(document.getElementById("p32").value),
				parseInt(document.getElementById("p33").value),
				parseInt(document.getElementById("p33").value)
			], [
				parseInt(document.getElementById("p41").value),
				parseInt(document.getElementById("p42").value),
				parseInt(document.getElementById("p43").value),
				parseInt(document.getElementById("p44").value)
			]
		];

		let topScore = 10000000.0;
		let lowScore = 10000000.0;

		let playerList = [];
		let roundResult = [];
		let finalEndPlayers = [];
		let playerGames = [ 0, 0, 0 ];
		let firstIteration = "";
		let survivingPlayers = players;
		let iterations = 10000;

		for (let h = 0; h < iterations; h++)
		{
			let round = 0;
			let strightGames = 0.0;
			survivingPlayers = players;

			playerList = [];
			for (let i = 0; i < players; i++)
			{
				let p = new Player(i, (lowScore + ((topScore - lowScore) * (i / (players - 1)))));
				playerList.push(p);
			}
			while (survivingPlayers > finalPlayers)
			{
				let singlePlayerMatches = [ 0, 0, 0 ];

				round++;

				allowed = [...playerList];

				while (allowed.length > 0)
				{
					let match = []
					let matchPlayers = 4;
					if (allowed.length === 9 || allowed.length === 6 || allowed.length === 5 || allowed.length === 3)
						matchPlayers = 3;
					else if (allowed.length ===  2)
						matchPlayers = 2;

					singlePlayerMatches[matchPlayers - 2]++;

					for (let j = 0; j < matchPlayers; j++)
					{
						let chosenPlayer = getRandomInt(allowed.length);
						match.push(allowed[chosenPlayer]);
						match[j].score = getRandomInt(match[j].topScore);
						allowed.splice(chosenPlayer, 1);
					}

					for (let j = 0; j < matchPlayers; j++)
					{
						let rank = 0; // Weird for someone to rank in 0th place, but since arrays are zero-based...
						for (let k = 0; k < matchPlayers; k++)
						{
							if (k == j) continue;
							if (match[j].score < match[k].score) rank++;
						}
						// The old calculator does it this way...
						//rank = (int)((double)match[j].score / match[j].topScore * matchPlayers) + 1;

						// This will carry over to playerList - match[j] is by reference.
						match[j].strikes += strikeDist[matchPlayers - 2][rank];
					}
					
				}
				for (let j = 0; j < playerList.length; j++) 
				{
					if (playerList[j].strikes >= finalStrikes) 
					{
						playerList.splice(j, 1);
						survivingPlayers--;
						j--;
					}				
				}
				if (h == 0)
					firstIteration += "R" + round + " -  Players:  " + survivingPlayers + " - 4P:  " + singlePlayerMatches[2] + " - 3P:  " + singlePlayerMatches[1] + " - 2P:  " + singlePlayerMatches[0] + "\r\n";

				playerGames[0] += singlePlayerMatches[0];
				playerGames[1] += singlePlayerMatches[1];
				playerGames[2] += singlePlayerMatches[2];
				strightGames++;
			}
			finalEndPlayers.push(survivingPlayers);
			if (h == 0)
				firstIteration += "End players:  " + survivingPlayers;

			roundResult.push(round);
		}

		//firstIterationDetail.Text = firstIteration;

		let roundAvg = average(roundResult);
		let endPlayersAvg = average(finalEndPlayers);
		let totalGames = playerGames[0] + playerGames[1] + playerGames[2];
		let totalTGP = playerGames[0] + (1.5 * playerGames[1]) + (2 * playerGames[2]);
		let pct5 = parseInt(iterations * 0.05);
		let pct95 = parseInt(iterations * 0.95);
		roundResult.sort();
		finalEndPlayers.sort();

		document.getElementById("tgpResult").value = 
			"Avg 2P games:  " + (playerGames[0] / iterations).toFixed(2) +
			"\r\nAvg 3P games:  " + (playerGames[1] / iterations).toFixed(2) +
			"\r\nAvg 4P games:  " + (playerGames[2] / iterations).toFixed(2) +
			"\r\nAvg total games:  " + (totalGames / iterations).toFixed(2) +
			"\r\n\r\nMeaningful games:  " + (roundAvg * totalTGP / totalGames).toFixed(2) + // Iterations not needed because of roundResult.Average()
			"\r\nApprox. TGP:  " + (roundAvg * totalTGP / totalGames * 4 > 100 ? "100.00% max reached (" + (roundAvg * totalTGP / totalGames * 4).toFixed(2) + "%)" : (roundAvg * totalTGP / totalGames * 4).toFixed(2) + "%") +
			"\r\n\r\nAverage rounds:  " + roundAvg.toFixed(2) +			
			"\r\nLeast/Most rounds:  " + Math.min(...roundResult) + " / " + Math.max(...roundResult) +
			"\r\n5th/95th percentile:  " + roundResult[pct5] + " / " + roundResult[pct95] +
			(finalPlayers > 1 ? 
				"\r\n\r\nAvg end players:  " + endPlayersAvg.toFixed(2) +
				"\r\nLeast/Most players:  " + Math.min(...finalEndPlayers) + " / " + Math.max(...finalEndPlayers) +
				"\r\n5th/95th percentile:  " + finalEndPlayers[pct5] + " / " + finalEndPlayers[pct95] 
				: "");
	}
	
	function getRandomInt(max) {
	  return Math.floor(Math.random() * max);
	}

	function average(numbers) 
	{
		let sum = 0;
		for (let i = 0; i < numbers.length; i++) 
		{
			sum += numbers[i];
		}
		return sum / numbers.length;
	}
</script>
